name: Deploy Newest version

on:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted]

    env:
      COMPOSE_PROJECT_NAME: tanknu
      PRESERVE_DB: ${{ vars.PRESERVE_DB || 'false' }}

    steps:
      - name: Pre-clean workspace
        shell: bash
        run: |
          set -e
          shopt -s dotglob nullglob
          if [ -d "$GITHUB_WORKSPACE" ]; then
            rm -rf "$GITHUB_WORKSPACE"/* || true
          fi

      - name: Checkout fresh
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      - name: Detect docker compose
        id: dccmd
        shell: bash
        run: |
          if docker compose version >/dev/null 2>&1; then
            echo "cmd=docker compose" >> "$GITHUB_OUTPUT"
          elif docker-compose version >/dev/null 2>&1; then
            echo "cmd=docker-compose" >> "$GITHUB_OUTPUT"
          else
            echo "Geen docker compose gevonden" >&2
            exit 1
          fi

      - name: Validate compose
        shell: bash
        run: |
          DC="${{ steps.dccmd.outputs.cmd }}"
          $DC config >/dev/null

      - name: Full stop & wipe (stop alles, inclusief volumes)
        shell: bash
        run: |
          set -e
          DC="${{ steps.dccmd.outputs.cmd }}"
          echo ">>> Compose down (all containers, networks, images)" 
          if [ "${PRESERVE_DB}" = "true" ]; then
            echo "DB preservatie actief -> compose down zonder volumes"
            $DC down --remove-orphans --rmi all || true
          else
            echo "Volledige wipe -> compose down inclusief volumes"
            $DC down --remove-orphans --rmi all --volumes || true
          fi

          echo ">>> Stop ALLE losse containers (failsafe)"
          if [ -n "$(docker ps -q)" ]; then
            docker stop $(docker ps -q) || true
          fi
          if [ -n "$(docker ps -aq)" ]; then
            docker rm -f $(docker ps -aq) || true
          fi

          if [ "${PRESERVE_DB}" != "true" ]; then
            echo ">>> Prune volumes/networks/images/cache (hard)"
            docker volume prune -f || true
          else
            echo ">>> Volumes worden behouden (PRESERVE_DB=true)"
          fi
          docker network prune -f || true
          docker image prune -f || true
          docker builder prune -f || true
          docker system prune -f || true

      - name: Build fresh & up
        shell: bash
        run: |
          set -e
          DC="${{ steps.dccmd.outputs.cmd }}"

          echo ">>> Build images with --no-cache and pull latest bases"
          $DC build --pull --no-cache

          echo ">>> Bring stack up clean using existing DB volume"
          $DC up -d --remove-orphans --renew-anon-volumes

      - name: Health check API
        shell: bash
        run: |
          set -e
          echo ">>> Wacht tot API gezond is"
          ATTEMPTS=30
          SLEEP=5
          URL="http://localhost:8080/health"
          for i in $(seq 1 $ATTEMPTS); do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
            if [ "$CODE" = "200" ]; then
              echo "API OK (200) na $i pogingen"
              exit 0
            fi
            echo "Nog niet gezond (code=$CODE), poging $i/$ATTEMPTS"; sleep $SLEEP
          done
          echo "API niet gezond binnen timeout" >&2
          exit 1

      - name: Status
        shell: bash
        run: |
          DC="${{ steps.dccmd.outputs.cmd }}"
          echo "== Compose ps =="
          $DC ps || true

          echo "== docker ps =="
          docker ps || true
          echo "== Volumes on host =="
          docker volume ls || true
